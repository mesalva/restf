"use strict";var __extends=this&&this.__extends||function(){var n=function(t,e){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)};return function(t,e){function r(){this.constructor=t}n(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}}(),__awaiter=this&&this.__awaiter||function(t,u,a,s){return new(a=a||Promise)(function(r,e){function n(t){try{i(s.next(t))}catch(t){e(t)}}function o(t){try{i(s.throw(t))}catch(t){e(t)}}function i(t){var e;t.done?r(t.value):((e=t.value)instanceof a?e:new a(function(t){t(e)})).then(n,o)}i((s=s.apply(t,u||[])).next())})},__generator=this&&this.__generator||function(r,n){var o,i,u,a={label:0,sent:function(){if(1&u[0])throw u[1];return u[1]},trys:[],ops:[]},t={next:e(0),throw:e(1),return:e(2)};return"function"==typeof Symbol&&(t[Symbol.iterator]=function(){return this}),t;function e(e){return function(t){return function(e){if(o)throw new TypeError("Generator is already executing.");for(;a;)try{if(o=1,i&&(u=2&e[0]?i.return:e[0]?i.throw||((u=i.return)&&u.call(i),0):i.next)&&!(u=u.call(i,e[1])).done)return u;switch(i=0,(e=u?[2&e[0],u.value]:e)[0]){case 0:case 1:u=e;break;case 4:return a.label++,{value:e[1],done:!1};case 5:a.label++,i=e[1],e=[0];continue;case 7:e=a.ops.pop(),a.trys.pop();continue;default:if(!(u=0<(u=a.trys).length&&u[u.length-1])&&(6===e[0]||2===e[0])){a=0;continue}if(3===e[0]&&(!u||e[1]>u[0]&&e[1]<u[3])){a.label=e[1];break}if(6===e[0]&&a.label<u[1]){a.label=u[1],u=e;break}if(u&&a.label<u[2]){a.label=u[2],a.ops.push(e);break}u[2]&&a.ops.pop(),a.trys.pop();continue}e=n.call(r,a)}catch(t){e=[6,t],i=0}finally{o=u=0}if(5&e[0])throw e[1];return{value:e[0]?e[1]:void 0,done:!0}}([e,t])}}},__importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0});var ioredis_1=__importDefault(require("ioredis")),CacheNotFoundError=function(e){function t(t){return e.call(this,"Cache not found for: "+t)||this}return __extends(t,e),t}(Error),Cache=function(){function t(t){(t=void 0===t?null:t)?this.redis=t:process.env.REDIS_URL&&(this.redis=new ioredis_1.default(process.env.REDIS_URL))}return t.prototype.use=function(r,n){return __awaiter(this,void 0,void 0,function(){var e=this;return __generator(this,function(t){return this.redis?[2,this.get(r).catch(function(t){return e.runFetcherThenSave(r,n)})]:[2,n()]})})},t.prototype.get=function(r){return __awaiter(this,void 0,void 0,function(){var e;return __generator(this,function(t){switch(t.label){case 0:return[4,this.redis.get(r)];case 1:if(!(e=t.sent()))throw new CacheNotFoundError(r);return[2,JSON.parse(e)]}})})},t.prototype.set=function(n,o){return __awaiter(this,void 0,void 0,function(){var e,r;return __generator(this,function(t){switch(t.label){case 0:return e=Number(process.env.CACHE_TIME||18e4),r=JSON.stringify(o),[4,this.redis.set(n,r,"EX",Math.floor(e/1e3))];case 1:return t.sent(),[2,o]}})})},t.prototype.clear=function(e){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,this.getCache(e)];case 1:return t.sent()?[4,this.redis.del(e)]:[2,!1];case 2:return t.sent(),[2,!0]}})})},t.prototype.clearAll=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return[2,this.redis.flushall("ASYNC")]})})},t.prototype.getCache=function(r){return __awaiter(this,void 0,void 0,function(){var e;return __generator(this,function(t){switch(t.label){case 0:return[4,this.redis.get(r)];case 1:if(!(e=t.sent()))throw new CacheNotFoundError(r);return[2,JSON.parse(e)]}})})},t.prototype.runFetcherThenSave=function(r,n){return __awaiter(this,void 0,void 0,function(){var e;return __generator(this,function(t){switch(t.label){case 0:return[4,n()];case 1:return e=t.sent(),[2,this.set(r,e)]}})})},t}();exports.default=Cache;