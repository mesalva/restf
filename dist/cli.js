#!/usr/bin/env node
"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,n){void 0===n&&(n=r),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,n){e[n=void 0===n?r:n]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.hasOwnProperty.call(e,r)&&__createBinding(t,e,r);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0});var fs=__importStar(require("fs")),projectPath=__dirname;projectPath.match(/node_modules\/(\.bin|restf)/)&&(projectPath=projectPath.replace(/\/node_modules\/(\.bin|restf)/,""));var _a=process.argv,args=_a.slice(2);function buildCommand(){var e=(0,require("child_process").spawn)("gulp",["build"]);e.stdout.setEncoding("utf8"),e.stdout.on("data",function(e){return process.stdout.write(e)}),e.stdout.on("end",function(){declareControllers("dist",args[1]),declareModels("dist")})}function buildDevCommand(){declareControllers(),declareModels()}function devCommand(){buildDevCommand();var e=(0,require("child_process").spawn)("ts-node",["--transpile-only","src/server.ts"]);e.stdout.setEncoding("utf8"),e.stdout.on("data",function(e){return process.stdout.write(e)})}function startCommand(){var e=(r=fs.readFileSync(projectPath+"/node_modules/restf/.allControllers.js","utf8")).replace(/\n/g,"å").replace(/å.*/g,"").replace(/\/\/ (.+)/,"$1"),t=projectPath+"/dist",r=r.replace(new RegExp(e+"/(src|dist)","g"),t).replace(new RegExp(e,"g"),projectPath);fs.writeFileSync(projectPath+"/node_modules/restf/.allControllers.js",r);r=(0,require("child_process").spawn)("node",["dist/server.js"]);r.stdout.setEncoding("utf8"),r.stdout.on("data",function(e){return process.stdout.write(e)})}function declareControllers(t,r){void 0===r&&(r=projectPath);var e=projectPath+"/"+(t=void 0===t?"src":t)+"/controllers";if(!fs.existsSync(e))return fs.writeFileSync(projectPath+"/node_modules/restf/.allControllers.js","module.exports = {}");var n=fs.readdirSync(e).filter(function(e){return e.match(/^[A-Z].*\.[tj]s$/)}).filter(function(e){return!e.match(/\.(d|test|spec)\.[tj]s$/)}).map(function(e){return e.replace(/\.[tj]s$/,"")}),e="// "+r+"\n\nmodule.exports = {\n";e+=n.map(function(e){return"  "+e+": require('"+r+"/"+t+"/controllers/"+e+"').default,"}).join("\n"),fs.writeFileSync(projectPath+"/node_modules/restf/.allControllers.js",e+="\n}")}function declareModels(t){void 0===t&&(t="src");function r(e){return projectPath+"/"+t+"/"+e}var e=function(e){return!fs.existsSync(r(e))};if(e("controllers")||e("models"))return null;e=mountDeclareModelsContent(fs.readdirSync(r("models")).filter(function(e){return e.match(/[A-Z].*\.[tj]s$/)}).filter(function(e){return!e.match(/\.(d|test|spec)\.[tj]s$/)}).map(function(e){return e.replace(/\.[tj]s$/,"")}).filter(function(e){return!e.match(/^(DB|ModelBase|DBBase|Model|Api|Search|SearchBase|\.base\.)$/)}),t);fs.writeFileSync(projectPath+"/node_modules/restf/.ControllerModels.js",e.js),fs.writeFileSync(projectPath+"/node_modules/restf/.ControllerModels.d.ts",e.declaration)}function mountDeclareModelsContent(e,t){var r='"use strict";\n';r+=e.map(function(e){return"const "+e+" = require('../../"+t+"/models/"+e+"').default"}).join("\n"),r+="\n\n\nvar ControllerModels = /** @class */ (function () {\n  function ControllerModels() {}\n",r+=e.map(function(e){return'  Object.defineProperty(ControllerModels.prototype, "'+e+'", {\n    get: function () {\n      const model = new '+e+"(this.headers)\n      if(typeof model.authenticate === 'function') model.authenticate(this.currentUser || {})\n      return model\n    },\n    enumerable: true,\n    configurable: true\n  });\n"}).join("\n"),r+="  return ControllerModels;\n}());\nmodule.exports = ControllerModels;";var n=e.map(function(e){return"import { I"+e+" } from '../../"+t+"/models/"+e+"'\n"}).join("");return n+="\nexport default class ControllerModels {\n",n+=e.map(function(e){return"  protected get "+e+"(): I"+e+";\n"}).join(""),{js:r,declaration:n+="}\n"}}"dev"===args[0]&&devCommand(),"build"===args[0]&&buildCommand(),"build-dev"===args[0]&&buildDevCommand(),"start"===args[0]&&startCommand(),"postinstall"===args[0]&&"production"!==process.env.NODE_ENV&&buildDevCommand();