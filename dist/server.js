"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),require("colors");var fs_1=__importDefault(require("fs")),path_1=__importDefault(require("path")),dotenv_1=__importDefault(require("dotenv")),xss_clean_1=__importDefault(require("xss-clean")),express_1=__importDefault(require("express")),express_fileupload_1=__importDefault(require("express-fileupload")),cookie_parser_1=__importDefault(require("cookie-parser")),helmet_1=__importDefault(require("helmet")),hpp_1=__importDefault(require("hpp")),_cors_1=__importDefault(require("./_cors"));fs_1.default.existsSync("./.env")&&dotenv_1.default.config({path:"./.env"}),fs_1.default.existsSync("./config/config.env")&&dotenv_1.default.config({path:"./config/config.env"});var mode=process.env.NODE_ENV||"development",RestfServer=function(){function e(e){void 0===e&&(e={}),this._app=express_1.default(),this.options=e,this.setContentMiddlewares(),this.setControllersMiddleware(),this.setSecurityMiddlewares(),this.setAfterMiddlewares()}return e.prototype.use=function(){for(var e,t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];return this._app.use(function(e,t,r){r()}),(e=this._app).use.apply(e,t)},e.prototype.apidocs=function(r,e){void 0===r&&(r="doc"),e=e||r,this._app.get("/"+e,function(e,t){return t.sendFile(process.cwd()+"/"+r+"/index.html")})},e.prototype.public=function(e){void 0===e&&(e="public"),this.use(express_1.default.static(path_1.default.join(__dirname,e)))},e.prototype.listen=function(e){void 0===e&&(e=5e3),this.setEndpointNotFoundMiddleware(),this.setGeneralErrorMiddleware(),this.setUnhandledRejection();var e=process.env.PORT||e.toString(),t=("Server running in "+mode+" mode on port "+e+"\n").cyan;this._app.listen(e,function(){return process.stdout.write(t)})},e.prototype.useAfter=function(e){this.afterMiddlewares.push(e)},e.prototype.setAfterMiddlewares=function(){var s=this;this.afterMiddlewares=[],this.use(function(e,t,r){return e.afterMiddlewares=s.afterMiddlewares,r()})},e.prototype.setSecurityMiddlewares=function(){this.use(helmet_1.default()),this.use(xss_clean_1.default()),this.use(hpp_1.default()),this.use(_cors_1.default(this.options.allowHosts,this.options.allowHeaders))},e.prototype.setContentMiddlewares=function(){this.use(express_1.default.json()),this.use(cookie_parser_1.default()),this.use(express_fileupload_1.default())},e.prototype.setControllersMiddleware=function(){this.use(function(e,t,r){e.AllControllers=require("./.allControllers"),r()})},e.prototype.setEndpointNotFoundMiddleware=function(){this.use(function(e,t){return t.status(404),t.json({error:"Endpoint not found"})})},e.prototype.setGeneralErrorMiddleware=function(){this.use(function(e,t,r,s){var o=e.message||"Server Error";return r.status(e.statusCode||500),r.json({error:o}),console.log(o),s()})},e.prototype.setUnhandledRejection=function(){process.on("unhandledRejection",function(e){process.stdout.write(("UnhandledRejection Error: "+e.message+"\n").red)})},e}();exports.default=RestfServer;